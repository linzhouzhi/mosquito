<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <link href="../vender/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" charset="utf-8" />
    <link href="../css/common.css" rel="stylesheet" charset="utf-8" />
    <style>

    </style>
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Mosquito</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="/role/add">add role <span class="sr-only">(current)</span></a></li>
                <li><a href="/role/list">role statistic</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>
<div style="width:10px;height:70px"></div>
<div class="container-fluid">
    <div class="container">
        <div class="row">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-plus"></span> add role</h3>
                </div>
                <div class="panel-body">
                    <div class="col-md-8" style="margin: 0 auto">
                        <div style="clear: both"></div>
                        <div class="form-group" style="width: 90%">
                            <label> 添加 role-name</label>
                            <input type="text" name="role_name" class="form-control" placeholder="service1预警"></input>
                        </div>
                        <div class="form-group" style="width: 90%">
                            <label> 添加 service</label>
                            <input type="text" name="service" class="form-control" placeholder="service001"></input>
                            <ul class="typeahead dropdown-menu all-service" role="listbox" style="top: 59px; left: 15px;display:none">
                                <li class="dropdown-li" th:each="item : ${apps}"><a class="dropdown-item" th:text="${item.service}"></a></li>
                            </ul>
                        </div>
                        <div class="form-group" style="width: 90%">
                            <label> 报警类型</label>
                            <div>
                                <label class="radio-inline">
                                    <input type="radio" name="type" value="ping" aria-controls="ping">ping</input>
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="type" value="error_log" aria-controls="error_log">error log</input>
                                </label>

                                <ul id="role-type" class="nav nav-tabs hidden" role="tablist">
                                    <li role="presentation" class="active"><a href="#ping" aria-controls="ping" role="tab" data-toggle="tab">Home</a></li>
                                    <li role="presentation"><a href="#error_log" aria-controls="error_log" role="tab" data-toggle="tab">Profile</a></li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div role="tabpanel" class="tab-pane active" id="ping">
                                        <div class="form-group">
                                            <label> 添加 url</label>
                                            <input type="text" name="ping_url" class="form-control" placeholder="http://127.0.0.1:80"></input>
                                        </div>
                                        <div class="form-group">
                                            <label> 选择超时时间</label>
                                            <select name="ping_timeout" class="form-control">
                                                <option value="5000">5s</option>
                                                <option value="10000">10s</option>
                                                <option value="15000">15s</option>
                                                <option value="20000">20s</option>
                                                <option value="25000">25s</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div role="tabpanel" class="tab-pane" id="error_log">暂不支持</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="width: 90%">
                            <label> 选择成员 </label>
                            <table>
                                <tbody>
                                <tr th:each="item : ${userLsit}" class="members-tr">
                                    <td th:text="${item.key}" valign="top"></td>
                                    <td>
                                        <label class="checkbox-inline" th:each="user : ${item.value}">
                                            <input type="checkbox" name="members" th:attr="value=${user.userid}" th:text="${user.userid}"></input>
                                        </label>
                                        <label class="checkbox-inline">
                                            <input type="checkbox" name="all_members" value="">@all</input>
                                        </label>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <button type="submit" id="role-submit" style="width:90%" class="btn btn-default btn-block">Submit</button>
                    </div><!-- .col-md-4 -->
                </div><!-- .panel-body -->
            </div><!-- .panel -->
        </div><!-- .row -->
    </div><!-- .container -->
</div><!-- .container-fluid -->

<!-- Modal -->
<div class="modal fade" id="para_list_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body">
                确认提交？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">no</button>
                <button type="button" class="btn btn-primary" id="submit-role-form">yes</button>
            </div>
        </div>
    </div>
</div>

<script src="../vender/jQuery/jquery-2.2.3.min.js"></script>
<script src="../vender/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<script src="../vender/bootstrap3-typeahead.js"></script>
<script src="../js/mosquito.js"></script>
<script th:inline="JavaScript">
/*<![CDATA[*/

    $("input[aria-controls='ping']").trigger("click");
    $("input[aria-controls='ping']").click(function () {
        $("a[aria-controls='ping']").click();
    });
    $("input[aria-controls='error_log']").click(function () {
        $("a[aria-controls='error_log']").click();
    });

    //******************  添加服务器
    var apps = /*[[${apps}]]*/;
    var app_names = [];
    for( var i in apps ){
        app_names.push( apps[i]["SERVICE"] )
    }
    var subjects = app_names;
    var allService = '';
    $("input[name='service']").typeahead({
        source: subjects
    });

    $("input[name='service']").click(function () {
        if( $(this).val() == "" ||  $(this).val() == " "){
            $("input[name='service']").after(allService);
        }
    });
    $("input[name='service']").bind('input focus propertychange',function () {
        var this_val = $(this).val();
        if( this_val == "" ||  this_val == " "){
            $(".all-service").css("display", "block");
        }else{
            $(".all-service").css("display", "none");
        }
    });
    // 添加完成后就可以绑定事件
    $(".dropdown-li").bind('click',function () {
        var text_value = $(this).text().trim();
        $("input[name='service']").val(text_value);
        $(".all-service").css("display", "none");
    });
    // 鼠标离开要隐藏掉
    $("input[name='service']").blur(function (e) {
        setTimeout(function () { //因为点击事件和鼠标离开事件绑定在同一个对象，所有要延迟一下
            console.log("aa");
            $(".all-service").css("display", "none");
        }, 500);
    });

    //************** 选择所有成员
    $("input[name='all_members']").click(function () {
        var checkboxs = $(this).parent(".checkbox-inline").prevAll().trigger("click");
        console.log(checkboxs);
    });

    // ************* 表单检查
    // 检查 input
    function input_check() {
        $("input[type='text']:visible").parent(".form-group").removeClass("has-error");
        var input_list = $("input[type='text']:visible");
        var flag = true;
        for( var i = 0; i < input_list.length; i++ ){
            var item = $(input_list[i]);
            if( item.val().trim() == ""){
                item.parent(".form-group").addClass("has-error");
                if( flag == true ){
                    flag = false;
                }
            }
        }
        var checkbox_arr = [];
        $('input[name="members"]:checked').each(function(){
            checkbox_arr.push( $(this).val() );
        });
        if( checkbox_arr.length == 0 ){
            $("input[name='members']").parents(".form-group").addClass("has-error");
            flag= false;
        }
        return flag;
    }

    // 表单检查
    $( document ).on( 'focus', 'input', function () {
        $(this).parents(".form-group").removeClass("has-error");
    } );
    $( document ).on( 'blur', 'input', function () {
        if( $(this).val().trim() == "" ){
            $(this).parent(".form-group").addClass("has-error");
        }
    } );

    // ************* 表单提交
    $("#role-submit").click(function () {
        // 检查 input 是否为空
        if( input_check() == false ){
            return;
        }
        var request_data = {};
        request_data.service = $('input[name="service"]').val();
        request_data.role_name = $('input[name="role_name"]').val();
        var type = $('input[name="type"]:checked').val();
        if( type == "ping" ){
            request_data.ping_url = $('input[name="ping_url"]').val();
            request_data.ping_timeout = $('select[name="ping_timeout"] option:selected').val();
        }
        var checkbox_arr = [];
        $('input[name="members"]:checked').each(function(){
            checkbox_arr.push( $(this).val() );
        });
        request_data.type = type;
        request_data.members = unique(checkbox_arr).join("|");

        $("#submit-role-form").data("request", request_data);
        $('#para_list_modal').modal('show');
    });
    $("#submit-role-form").click(function () {
        var request_data = $("#submit-role-form").data("request");
        request_data = JSON.stringify(request_data);
        set_cookie("role_form_data", request_data);
        console.log(request_data);
        $.ajax({
            url:'/role/role_submit_ajax',
            type:'POST',
            contentType: 'application/json',
            async:true,
            data:request_data,
            timeout:5000,
            dataType:'json',
            success:function(data){
                $("[data-dismiss='modal']").trigger("click");
            }
        });
    });
    //**********从cookie中取值初始化表单
    function init_form() {
        var role_form_str = get_cookie("role_form_data");
        var role_form_value = JSON.parse(role_form_str);
        $("input[name='service']").val(role_form_value.service);
        $("input[name='role_name']").val(role_form_value.role_name);
        $("input[name='ping_url']").val(role_form_value.ping_url);
        $("input[name='type'][value='"+role_form_value.type+"']").trigger("click");
        $("select").find("option[value='"+role_form_value.ping_timeout+"']").attr("selected",true);
        var members = role_form_value.members.split("|");
        for (index in members){
            $("input[name='members'][value='"+members[index]+"']").attr("checked", true);
        }
    }
    // 数组去重，因为选择成员不需要重复
    function unique(arr) {
        var result = [], hash = {};
        for (var i = 0, elem; (elem = arr[i]) != null; i++) {
            if (!hash[elem]) {
                result.push(elem);
                hash[elem] = true;
            }
        }
        return result;
    }

    $(function () {
        init_form();
    })
/*]]>*/
</script>
</body>
</html>